<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BIMA - Asisten UMKM Anda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* Safe Area untuk Notch */
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .bg-3d {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      transform-style: preserve-3d; animation: floatPanels 12s infinite ease-in-out;
    }
    .panel {
      position: absolute; width: 250px; height: 250px;
      background: rgba(255,255,255,0.12); backdrop-filter: blur(8px);
      border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      transform: translateZ(-100px) rotateY(25deg) rotateX(15deg);
      animation: panelFloat 8s infinite alternate ease-in-out;
    }
    .panel:nth-child(1) { top: 10%; left: 5%; }
    .panel:nth-child(2) { top: 25%; right: 10%; transform: translateZ(-180px) rotateY(-20deg) rotateX(10deg); }
    .panel:nth-child(3) { bottom: 20%; left: 15%; transform: translateZ(-120px) rotateY(15deg) rotateX(-20deg); }
    .panel:nth-child(4) { bottom: 10%; right: 15%; transform: translateZ(-220px) rotateY(-10deg) rotateX(25deg); }
    @keyframes floatPanels {
      0%,100% { transform: translateY(0) rotateX(0); }
      50% { transform: translateY(-8px) rotateX(0.5deg); }
    }
    @keyframes panelFloat {
      0% { transform: translateZ(-100px) rotateY(25deg) rotateX(15deg); }
      100% { transform: translateZ(-100px) rotateY(-25deg) rotateX(-15deg); }
    }
    [data-theme="dark"] .bg-3d .panel { background: rgba(0,0,0,0.15); }
    [data-theme="dark"] .message-ai { background: #1e293b !important; color: white; }
    [data-theme="dark"] .message-user { background: #334155 !important; color: white; }
    .file-preview {
      font-size: 0.75rem; color: #64748b; margin-top: 4px;
      max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* Mobile First Responsive */
    @media (max-width: 414px) {
      #sidebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        height: 100vh;
        z-index: 50;
      }
      #sidebar.mobile-open {
        display: flex !important;
      }
      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        z-index: 40;
      }
      .mobile-overlay.active {
        display: block;
      }

      /* Input lebih besar di mobile kecil */
      #msgInput {
        font-size: 1rem !important;
        padding: 0.75rem 1rem !important;
      }

      /* Title chat lebih pendek */
      #chatTitle {
        max-width: 120px !important;
      }

      /* Padding lebih longgar */
      #chatBox {
        padding: 1rem !important;
      }
    }

    /* Tablet / Desktop */
    @media (min-width: 768px) {
      #app {
        flex-direction: row;
      }
      #sidebar {
        display: flex !important;
      }
      #chatArea {
        max-width: 100%;
      }
    }
  </style>
</head>
<body class="min-h-screen flex bg-gradient-to-br from-blue-50 to-cyan-100">
  <!-- 3D Background -->
  <div class="bg-3d">
    <div class="panel"></div>
    <div class="panel"></div>
    <div class="panel"></div>
    <div class="panel"></div>
  </div>

  <!-- Overlay Mobile Sidebar -->
  <div id="overlay" class="mobile-overlay"></div>

  <!-- LANDING PAGE -->
  <div id="landing" class="w-full h-screen flex flex-col items-center justify-center px-4 sm:px-6 text-center z-10">
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600 mb-3">Asisten Keuangan UMKM</h1>
    <p class="text-gray-700 max-w-xs sm:max-w-md mb-5 text-sm sm:text-base">Bantu catat keuangan, analisis dokumen, dan pelajari video lokal ‚Äî semua lewat chat.</p>
    <div class="mb-5 text-xs sm:text-sm text-gray-600 space-y-1">
      <div>AI powered by <span class="font-semibold text-blue-600">Kolosal</span></div>
      <div>Developer by <span class="font-semibold">Faril, Zhafran, Dandi</span></div>
    </div>
    <a href="https://github.com/FARILtau72/BIMAV2" target="_blank" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 bg-gray-800 text-white rounded-full text-xs sm:text-sm font-medium hover:bg-gray-900 transition mb-3">
      <i class="fab fa-github"></i> Lihat di GitHub
    </a>
    <button id="startBtn" class="px-5 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-full font-medium hover:bg-blue-700 transition shadow-lg text-sm sm:text-base">
      Mulai Sekarang
    </button>
  </div>

  <!-- APP (CHAT UI) -->
  <div id="app" class="hidden w-full h-[100dvh] flex flex-col">
    <!-- SIDEBAR -->
    <div id="sidebar" class="w-72 bg-slate-800/90 text-white flex flex-col backdrop-blur-sm border-r border-slate-700 h-[100dvh]">
      <div class="p-3 sm:p-4 border-b border-slate-700 flex justify-between items-center">
        <h2 class="font-bold">BIMA</h2>
        <div class="flex gap-2">
          <button id="newChatBtn" class="text-blue-400 text-xs sm:text-sm font-medium">+ New</button>
          <button id="themeToggle" class="text-lg">üåô</button>
        </div>
      </div>
      <div id="chatList" class="flex-1 p-2 space-y-1 overflow-y-auto"></div>
    </div>

    <!-- MOBILE MENU BUTTON -->
    <button id="mobileMenuBtn" class="md:hidden absolute top-4 left-4 z-20 bg-slate-800/80 text-white p-2 rounded-full">‚ò∞</button>

    <!-- CHAT AREA -->
    <div class="flex-1 flex flex-col bg-white/90 backdrop-blur-sm h-[100dvh] max-w-4xl w-full mx-auto">
      <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-gray-700">
        <div id="chatTitle" class="font-semibold text-blue-700 dark:text-blue-400 cursor-pointer max-w-xs truncate">New Chat</div>
      </div>
      <div id="chatBox" class="flex-1 p-3 sm:p-5 space-y-3 sm:space-y-4 overflow-y-auto min-h-0"></div>
      <div class="p-3 sm:p-4 border-t border-gray-200 dark:border-gray-700">
        <div id="filePreview" class="file-preview hidden"></div>
        <div class="flex gap-1 sm:gap-2 mt-1">
          <input type="text" id="msgInput" placeholder="Ketik pesan..." class="flex-1 border rounded-full px-3 sm:px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-300 dark:bg-gray-800 dark:text-white" />
          <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.mp4" class="hidden" />
          <button id="fileBtn" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900 dark:text-blue-200">üìé</button>
          <button id="sendBtn" class="w-10 h-10 rounded-full bg-blue-600 text-white">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============== UTILS ==============
    let chats = JSON.parse(localStorage.getItem('chats')) || [];
    let currentId = null;

    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');

    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) {
        filePreview.textContent = `üìÑ ${fileInput.files[0].name}`;
        filePreview.classList.remove('hidden');
      }
    });

    const save = () => localStorage.setItem('chats', JSON.stringify(chats));
    const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const addMsg = (role, txt) => {
      const div = document.createElement('div');
      div.className = `max-w-[80%] p-2 sm:p-3 rounded-2xl ${role === 'user' ? 'ml-auto bg-blue-100 message-user' : 'bg-gray-100 message-ai'}`;
      div.innerHTML = txt.replace(/\n/g, '<br>');
      document.getElementById('chatBox').appendChild(div);
      document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
    };

    // ============== CHAT LIST ==============
    const renderList = () => {
      const el = document.getElementById('chatList');
      el.innerHTML = '';
      const groups = {};
      chats.forEach(c => {
        const now = Date.now();
        const diffDays = (now - new Date(c.created)) / (1000 * 60 * 60 * 24);
        let key;
        if (diffDays < 1) key = 'Today';
        else if (diffDays < 2) key = 'Yesterday';
        else if (diffDays < 7) key = 'Last week';
        else key = 'Older';
        groups[key] = groups[key] || [];
        groups[key].push(c);
      });

      Object.entries(groups).forEach(([date, list]) => {
        el.innerHTML += `<div class="px-3 py-1 text-slate-400 text-xs">${date}</div>`;
        list.forEach(c => {
          const active = c.id === currentId ? 'bg-slate-700 border-l-2 border-l-blue-400' : 'hover:bg-slate-700/50';
          el.innerHTML += `
            <div class="p-2 rounded cursor-pointer ${active}" data-id="${c.id}">
              <div class="truncate text-sm">${c.title || 'New Chat'}</div>
              <div class="text-xs text-slate-500">${new Date(c.created).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            </div>`;
        });
      });

      el.querySelectorAll('div[data-id]').forEach(el => {
        el.addEventListener('click', () => loadChat(el.dataset.id));
      });
    };

    // ============== CHAT CONTROL ==============
    const loadChat = (id) => {
      currentId = id;
      const chat = chats.find(c => c.id === id);
      if (!chat) return;
      document.getElementById('chatTitle').textContent = chat.title || 'New Chat';
      document.getElementById('chatBox').innerHTML = '';
      chat.msgs.forEach(m => addMsg(m.role, m.txt));
      renderList();
      document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
    };

    const newChat = () => {
      const chat = { id: genId(), title: 'New Chat', created: Date.now(), msgs: [] };
      chats.unshift(chat);
      currentId = chat.id;
      save();
      loadChat(chat.id);
      renderList();
    };

    const sendMsg = async () => {
      const txt = document.getElementById('msgInput').value.trim();
      const file = fileInput.files[0];
      if (!txt && !file) return;

      let userTxt = txt || '[File dikirim]';
      if (file) userTxt += ` (üìÑ ${file.name})`;

      addMsg('user', userTxt);
      addMsg('ai', 'Menganalisis...');

      const fd = new FormData();
      if (txt) fd.append('message', txt);
      if (file) fd.append('file', file);

      try {
        const res = await fetch('/api/chat', { method: 'POST', body: fd });
        const data = await res.json();
        document.getElementById('chatBox').lastElementChild.remove();
        addMsg('ai', data.reply);

        const chat = chats.find(c => c.id === currentId);
        if (chat) {
          chat.msgs.push({ role: 'user', txt: userTxt });
          chat.msgs.push({ role: 'ai', txt: data.reply });
          if (chat.title === 'New Chat' && txt) {
            chat.title = txt.split(' ').slice(0, 5).join(' ') + (txt.split(' ').length > 5 ? '...' : '');
            document.getElementById('chatTitle').textContent = chat.title;
          }
          save();
        }
      } catch (e) {
        document.getElementById('chatBox').lastElementChild.remove();
        addMsg('ai', 'Gagal koneksi ke server.');
      }

      document.getElementById('msgInput').value = '';
      fileInput.value = '';
      filePreview.classList.add('hidden');
    };

    // ============== THEME ==============
    const toggleTheme = () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      updateBodyBg();
    };

    const updateBodyBg = () => {
      const theme = document.documentElement.getAttribute('data-theme');
      document.body.className = theme === 'dark'
        ? 'min-h-screen flex bg-gradient-to-br from-slate-900 to-slate-800'
        : 'min-h-screen flex bg-gradient-to-br from-blue-50 to-cyan-100';
    };

    // ============== MOBILE SIDEBAR ==============
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const overlay = document.getElementById('overlay');

    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.add('mobile-open');
      overlay.classList.add('active');
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
    });

    // ============== EVENT LISTENERS ==============
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      if (chats.length === 0) {
        newChat();
      } else {
        currentId = chats[0].id;
        loadChat(currentId);
      }
      renderList();
      updateBodyBg();
    });

    document.getElementById('newChatBtn').addEventListener('click', newChat);
    document.getElementById('sendBtn').addEventListener('click', sendMsg);
    document.getElementById('fileBtn').addEventListener('click', () => fileInput.click());
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMsg();
    });
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('chatTitle').addEventListener('click', () => {
      const chat = chats.find(c => c.id === currentId);
      if (chat) {
        const newTitle = prompt('Ganti nama:', chat.title);
        if (newTitle?.trim()) {
          chat.title = newTitle.trim();
          document.getElementById('chatTitle').textContent = newTitle.trim();
          save();
          renderList();
        }
      }
    });

    // ============== INIT ==============
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateBodyBg();
    document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  </script>
</body>
</html>
